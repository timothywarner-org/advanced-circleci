<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircleCI Pipeline - Robot Fleet API</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #fff;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 2rem;
            font-size: 1rem;
        }
        .diagram-container {
            background: #ffffff;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #334155;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #cbd5e1;
        }
        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .legend-dot.trigger { background: #1e40af; }
        .legend-dot.orb { background: #0891b2; }
        .legend-dot.build { background: #0369a1; }
        .legend-dot.test { background: #7c3aed; }
        .legend-dot.deploy { background: #c2410c; }
        .legend-dot.approval { background: #ca8a04; }
        .legend-dot.prod { background: #be185d; }
        footer {
            text-align: center;
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Robot Fleet API Pipeline</h1>
        <p class="subtitle">CircleCI Workflow Architecture</p>

        <div class="diagram-container">
            <pre class="mermaid">
%%{init: {
  'theme': 'base',
  'themeVariables': {
    'fontSize': '13px',
    'fontFamily': 'system-ui, sans-serif'
  }
}}%%
flowchart TB
    subgraph TRIGGER["üì• TRIGGER"]
        PUSH[/"Git Push"/]
    end

    subgraph ORBS["üì¶ ORBS"]
        NODE_ORB["circleci/node@7.2.1"]
        CUSTOM_ORB["robot-fleet ‚Äî custom orb"]
    end

    subgraph BUILD_STAGE["üî® BUILD"]
        BUILD["<b>build</b><br/>checkout ‚Üí install ‚Üí build<br/>‚Üí persist workspace"]
    end

    subgraph TEST_STAGE["üß™ TEST"]
        TEST["<b>test</b><br/>npm test ‚Üí store results<br/>‚Üí notify on fail ‚ùå"]
    end

    subgraph DEPLOY_DEV["üöÄ DEV ‚Äî feature/develop branches"]
        DEV["<b>deploy-dev</b><br/>Azure deploy ‚Üí health-check<br/>‚Üí validate ‚Üí notify ‚úÖ"]
    end

    subgraph DEPLOY_MAIN["üöÄ MAIN BRANCH ONLY"]
        STAGING["<b>deploy-staging</b><br/>Azure deploy ‚Üí health-check<br/>‚Üí validate ‚Üí notify ‚úÖ"]

        NOTIFY_AWAIT["‚è≥ <b>notify-awaiting-approval</b><br/>Slack notification"]

        APPROVAL{{"‚è∏Ô∏è <b>hold-for-production</b><br/>MANUAL APPROVAL"}}

        PROD["<b>deploy-prod</b><br/>Azure deploy ‚Üí health-check<br/>‚Üí validate ‚Üí notify ‚úÖ"]
    end

    %% Main flow
    PUSH --> BUILD
    BUILD --> TEST
    TEST -->|"feature/* develop"| DEV
    TEST -->|"main"| STAGING
    STAGING --> NOTIFY_AWAIT
    NOTIFY_AWAIT --> APPROVAL
    APPROVAL -->|"Approved ‚úì"| PROD

    %% Orb connections
    NODE_ORB -.->|"install-packages"| BUILD
    CUSTOM_ORB -.->|"health-check validate"| DEV
    CUSTOM_ORB -.->|"health-check validate"| STAGING
    CUSTOM_ORB -.->|"health-check validate"| PROD

    %% Styling - Colorblind safe palette (no red/green)
    classDef trigger fill:#1e40af,stroke:#1e3a8a,color:#fff,stroke-width:2px
    classDef orb fill:#0891b2,stroke:#0e7490,color:#fff,stroke-width:2px
    classDef build fill:#0369a1,stroke:#075985,color:#fff,stroke-width:2px
    classDef test fill:#7c3aed,stroke:#6d28d9,color:#fff,stroke-width:2px
    classDef deploy fill:#c2410c,stroke:#9a3412,color:#fff,stroke-width:2px
    classDef approval fill:#ca8a04,stroke:#a16207,color:#000,stroke-width:3px
    classDef prod fill:#be185d,stroke:#9d174d,color:#fff,stroke-width:2px

    class PUSH trigger
    class NODE_ORB,CUSTOM_ORB orb
    class BUILD build
    class TEST test
    class DEV,STAGING,NOTIFY_AWAIT deploy
    class APPROVAL approval
    class PROD prod
            </pre>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot trigger"></div>
                <span>Trigger</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot orb"></div>
                <span>Orbs</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot build"></div>
                <span>Build</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot test"></div>
                <span>Test</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot deploy"></div>
                <span>Deploy</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot approval"></div>
                <span>Approval Gate</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot prod"></div>
                <span>Production</span>
            </div>
        </div>

        <footer>
            Globomantics Robot Fleet API &bull; CircleCI Advanced Configuration
        </footer>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 60
            }
        });
    </script>
</body>
</html>
