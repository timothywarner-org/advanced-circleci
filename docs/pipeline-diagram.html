<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircleCI Pipeline - Globomantics Robot Fleet API</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #fff;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            color: #a0aec0;
            margin-bottom: 2rem;
        }
        .diagram-container {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            margin-bottom: 2rem;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        .legend-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid;
        }
        .legend-item.trigger { border-color: #1e3a5f; }
        .legend-item.orb { border-color: #805ad5; }
        .legend-item.build { border-color: #22543d; }
        .legend-item.test { border-color: #3b82f6; }
        .legend-item.deploy { border-color: #ea580c; }
        .legend-item.approval { border-color: #f59e0b; }
        .legend-item.prod { border-color: #dc2626; }
        .legend-item h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
        .legend-item p { margin: 0; font-size: 0.875rem; color: #a0aec0; }
        footer {
            text-align: center;
            color: #718096;
            font-size: 0.875rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CircleCI Pipeline Architecture</h1>
        <p class="subtitle">Globomantics Robot Fleet API - Build, Test, Deploy Workflow</p>

        <div class="diagram-container">
            <pre class="mermaid">
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1a365d', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2c5282', 'lineColor': '#4a5568', 'secondaryColor': '#2d3748', 'fontFamily': 'Arial, sans-serif'}}}%%
flowchart TB
    subgraph TRIGGER["&nbsp; GIT PUSH &nbsp;"]
        PUSH[/"Push to Repository"/]
    end

    subgraph ORBS["&nbsp; ORBS &nbsp;"]
        NODE_ORB["circleci/node@7.2.1"]
        CUSTOM_ORB["robot-fleet - custom orb"]
    end

    subgraph BUILD_STAGE["&nbsp; BUILD STAGE &nbsp;"]
        BUILD["BUILD JOB<br/>━━━━━━━━━━━━━<br/>checkout<br/>node/install-packages<br/>npm run build<br/>persist_to_workspace"]
    end

    subgraph TEST_STAGE["&nbsp; TEST STAGE &nbsp;"]
        TEST["TEST JOB<br/>━━━━━━━━━━━━━<br/>attach_workspace<br/>npm test<br/>store_test_results<br/>notify-slack-on-failure"]
    end

    subgraph DEPLOY_FEATURE["&nbsp; FEATURE/DEVELOP BRANCHES &nbsp;"]
        DEV["DEPLOY-DEV<br/>━━━━━━━━━━━━━<br/>simulate-azure-deployment<br/>robot-fleet/health-check<br/>robot-fleet/validate-deployment<br/>notify-slack SUCCESS"]
    end

    subgraph DEPLOY_MAIN["&nbsp; MAIN BRANCH PIPELINE &nbsp;"]
        STAGING["DEPLOY-STAGING<br/>━━━━━━━━━━━━━<br/>simulate-azure-deployment<br/>robot-fleet/health-check<br/>robot-fleet/validate-deployment<br/>notify-slack SUCCESS"]

        NOTIFY_AWAIT["NOTIFY-AWAITING-APPROVAL<br/>━━━━━━━━━━━━━<br/>Slack: Awaiting Approval"]

        APPROVAL{{"HOLD-FOR-PRODUCTION<br/>━━━━━━━━━━━━━<br/>MANUAL APPROVAL<br/>REQUIRED"}}

        PROD["DEPLOY-PROD<br/>━━━━━━━━━━━━━<br/>simulate-azure-deployment<br/>robot-fleet/health-check<br/>robot-fleet/validate-deployment<br/>notify-slack SUCCESS"]
    end

    %% Main flow connections
    PUSH --> BUILD
    BUILD --> TEST
    TEST -->|"feature/* or develop"| DEV
    TEST -->|"main branch"| STAGING
    STAGING --> NOTIFY_AWAIT
    NOTIFY_AWAIT --> APPROVAL
    APPROVAL -->|"Approved"| PROD

    %% Orb usage dotted lines
    NODE_ORB -.->|"install-packages"| BUILD
    CUSTOM_ORB -.->|"health-check<br/>validate-deployment"| DEV
    CUSTOM_ORB -.->|"health-check<br/>validate-deployment"| STAGING
    CUSTOM_ORB -.->|"health-check<br/>validate-deployment"| PROD

    %% Styling classes
    classDef triggerStyle fill:#1e3a5f,stroke:#2c5282,color:#fff,stroke-width:2px,font-weight:bold
    classDef orbStyle fill:#553c9a,stroke:#805ad5,color:#fff,stroke-width:2px
    classDef buildStyle fill:#22543d,stroke:#38a169,color:#fff,stroke-width:2px
    classDef testStyle fill:#1e40af,stroke:#3b82f6,color:#fff,stroke-width:2px
    classDef deployStyle fill:#9a3412,stroke:#ea580c,color:#fff,stroke-width:2px
    classDef approvalStyle fill:#d97706,stroke:#f59e0b,color:#000,stroke-width:3px,font-weight:bold
    classDef prodStyle fill:#991b1b,stroke:#dc2626,color:#fff,stroke-width:2px

    class PUSH triggerStyle
    class NODE_ORB,CUSTOM_ORB orbStyle
    class BUILD buildStyle
    class TEST testStyle
    class DEV,STAGING deployStyle
    class APPROVAL approvalStyle
    class PROD prodStyle
            </pre>
        </div>

        <div class="legend">
            <div class="legend-item trigger">
                <h3>Trigger</h3>
                <p>Git push to main, develop, or feature/* branches</p>
            </div>
            <div class="legend-item orb">
                <h3>Orbs</h3>
                <p>circleci/node for caching, robot-fleet for health checks</p>
            </div>
            <div class="legend-item build">
                <h3>Build Stage</h3>
                <p>Install dependencies, build app, persist workspace</p>
            </div>
            <div class="legend-item test">
                <h3>Test Stage</h3>
                <p>Run tests, store results, notify Slack on failure</p>
            </div>
            <div class="legend-item deploy">
                <h3>Deploy Stage</h3>
                <p>Simulate Azure deployment, validate with orb commands</p>
            </div>
            <div class="legend-item approval">
                <h3>Approval Gate</h3>
                <p>Manual approval required before production deploy</p>
            </div>
            <div class="legend-item prod">
                <h3>Production</h3>
                <p>Final deployment to production environment</p>
            </div>
        </div>

        <footer>
            <p>Globomantics Robot Fleet API - CircleCI Advanced Configuration Course</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
