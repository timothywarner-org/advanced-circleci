# Globomantics Robot Fleet API - CircleCI Pipeline

version: 2.1

# ORBS
orbs:
  node: circleci/node@7.2.1
  slack: circleci/slack@4.13.3

  # Custom orb (inline for development, publish as globomantics/robot-fleet@1.0.0)
  robot-fleet:
    commands:
      health-check:
        description: "Check if the Robot Fleet API is healthy"
        parameters:
          url:
            type: string
          endpoint:
            type: string
            default: "/api/health"
          retries:
            type: integer
            default: 5
          retry-delay:
            type: integer
            default: 10
        steps:
          - run:
              name: Health Check - << parameters.url >><< parameters.endpoint >>
              command: |
                echo "Health Check: << parameters.url >><< parameters.endpoint >>"
                echo "Retries: << parameters.retries >>"

                for i in $(seq 1 << parameters.retries >>); do
                  echo "Attempt $i of << parameters.retries >>..."

                  if curl -sf --max-time 30 \
                    "<< parameters.url >><< parameters.endpoint >>" > /dev/null 2>&1; then
                    echo "Health check PASSED!"
                    exit 0
                  fi

                  if [ $i -lt << parameters.retries >> ]; then
                    echo "Failed, waiting << parameters.retry-delay >> seconds..."
                    sleep << parameters.retry-delay >>
                  fi
                done

                echo "Health check FAILED after << parameters.retries >> attempts"
                echo "(Continuing - simulated environment)"

      validate-deployment:
        description: "Validate a Robot Fleet API deployment"
        parameters:
          url:
            type: string
          check-robots:
            type: boolean
            default: true
        steps:
          - run:
              name: Validate Deployment - << parameters.url >>
              command: |
                echo "Validating: << parameters.url >>"
                echo "  [PASS] Health endpoint responding (simulated)"

                if [ "<< parameters.check-robots >>" = "true" ]; then
                  echo "  [PASS] Robots endpoint returning data (simulated)"
                fi

                echo "All validation checks PASSED!"

# EXECUTORS
executors:
  node-executor:
    docker:
      - image: cimg/node:22.16.0
    working_directory: ~/robot-fleet-api
    resource_class: medium

  vm-executor:
    machine:
      image: ubuntu-2404:current
    resource_class: medium

# COMMANDS
commands:
  notify-slack:
    parameters:
      message:
        type: string
      color:
        type: string
        default: "#36a64f"
    steps:
      - run:
          name: Send Slack Notification
          command: |
            curl -X POST "$SLACK_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d '{
                "channel": "#circleci-builds",
                "attachments": [{
                  "color": "<< parameters.color >>",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "[WEBHOOK] << parameters.message >>"
                      }
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:* '"$CIRCLE_BRANCH"' | *Job:* '"$CIRCLE_JOB"' | <'"$CIRCLE_BUILD_URL"'|View Build>"
                        }
                      ]
                    }
                  ]
                }]
              }'

  notify-slack-on-failure:
    steps:
      - run:
          name: Notify Slack on Failure
          when: on_fail
          command: |
            curl -X POST "$SLACK_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d '{
                "channel": "#circleci-builds",
                "attachments": [{
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "[WEBHOOK] Build Failed - Robot Fleet API\n'"$CIRCLE_JOB"' failed on branch `'"$CIRCLE_BRANCH"'`"
                      }
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:* '"$CIRCLE_BRANCH"' | *Commit:* '"${CIRCLE_SHA1:0:7}"' | <'"$CIRCLE_BUILD_URL"'|View Build>"
                        }
                      ]
                    }
                  ]
                }]
              }'

  simulate-azure-deployment:
    parameters:
      environment:
        type: enum
        enum: [dev, staging, prod]
      app-name:
        type: string
    steps:
      - run:
          name: Simulate Azure Container Build
          command: |
            echo "Building container image: robot-fleet-api:${CIRCLE_SHA1:0:7}"
            echo "Environment: << parameters.environment >>"
            sleep 2

      - run:
          name: Simulate Azure Container App Deployment
          command: |
            echo "Deploying to Azure Container Apps"
            echo "App: << parameters.app-name >>"
            echo "Resource Group: rg-globomantics-<< parameters.environment >>"
            echo "Image: robot-fleet-api:${CIRCLE_SHA1:0:7}"
            echo ""
            echo "  1. Authenticating to Azure..."
            echo "  2. Pushing image to ACR..."
            echo "  3. Updating container app..."
            echo "  4. Verifying health check..."
            echo ""
            echo "URL: https://<< parameters.app-name >>.azurecontainerapps.io"

      - run:
          name: Simulate Health Check
          command: |
            echo "Health Check: https://<< parameters.app-name >>.azurecontainerapps.io/api/health"
            for i in {1..3}; do
              echo "Attempt $i/3... HTTP 200 OK"
              sleep 1
            done

# JOBS
jobs:
  build:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-version: v1
      - run:
          name: Build Application
          command: |
            echo "Building Robot Fleet API..."
            npm run build
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - dist
            - package*.json

  # Machine executor required for Docker-in-Docker
  build-image:
    executor: vm-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Build Docker Image
          command: |
            IMAGE_TAG="robot-fleet-api:${CIRCLE_SHA1:0:7}"
            echo "Building Docker image: $IMAGE_TAG"
            docker build -t $IMAGE_TAG .
      - run:
          name: Smoke Test Container
          command: |
            IMAGE_TAG="robot-fleet-api:${CIRCLE_SHA1:0:7}"
            docker run -d --name smoke-test -p 3000:3000 $IMAGE_TAG
            sleep 5

            if curl -sf --max-time 10 http://localhost:3000/api/health; then
              echo "Smoke test PASSED"
            else
              docker logs smoke-test
              exit 1
            fi

            docker stop smoke-test
            docker rm smoke-test

  test:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run Unit Tests
          command: npm test
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-report
      # Both notification methods fire on failure - compare in Slack
      - notify-slack-on-failure
      - slack/notify:
          event: fail
          channel: circleci-builds
          template: basic_fail_1

  deploy:
    executor: node-executor
    parameters:
      environment:
        type: enum
        enum: [dev, staging, prod]
      app-name:
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: .
      - simulate-azure-deployment:
          environment: << parameters.environment >>
          app-name: << parameters.app-name >>
      - robot-fleet/health-check:
          url: https://<< parameters.app-name >>.azurecontainerapps.io
          endpoint: /api/health
          retries: 3
          retry-delay: 5
      - robot-fleet/validate-deployment:
          url: https://<< parameters.app-name >>.azurecontainerapps.io
          check-robots: true
      - notify-slack:
          message: "Deployed to << parameters.environment >> - Robot Fleet API\\nApp: `<< parameters.app-name >>`"
          color: "#36a64f"

  notify-awaiting-approval:
    executor: node-executor
    steps:
      - notify-slack:
          message: "Awaiting Production Approval - Robot Fleet API\\nStaging deployed. Manual approval required."
          color: "#ffc107"

  # Alternative: Slack orb approach (requires SLACK_ACCESS_TOKEN instead of SLACK_WEBHOOK)
  notify-awaiting-approval-orb:
    executor: node-executor
    steps:
      - slack/notify:
          event: always
          channel: circleci-builds
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "[ORB] Awaiting Production Approval - Robot Fleet API\nStaging deployed. Manual approval required."
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:* $CIRCLE_BRANCH | *Commit:* ${CIRCLE_SHA1:0:7} | <$CIRCLE_BUILD_URL|Approve in CircleCI>"
                    }
                  ]
                }
              ]
            }

# WORKFLOWS
workflows:
  version: 2

  build-test-deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - main
                - develop
                - /feature\/.*/

      - test:
          requires:
            - build
          context: slack-notifications

      - build-image:
          requires:
            - build

      # Dev: auto-deploy from feature branches
      - deploy:
          name: deploy-dev
          environment: dev
          app-name: robot-api-dev
          requires:
            - test
          context: slack-notifications
          filters:
            branches:
              only:
                - develop
                - /feature\/.*/

      # Staging: auto-deploy from main
      - deploy:
          name: deploy-staging
          environment: staging
          app-name: robot-api-staging
          requires:
            - test
          context: slack-notifications
          filters:
            branches:
              only: main

      # Webhook approach (uses SLACK_WEBHOOK)
      - notify-awaiting-approval:
          requires:
            - deploy-staging
          context: slack-notifications
          filters:
            branches:
              only: main

      # Orb approach (uses SLACK_ACCESS_TOKEN) - runs in parallel to compare
      - notify-awaiting-approval-orb:
          requires:
            - deploy-staging
          context: slack-notifications
          filters:
            branches:
              only: main

      # Production: requires manual approval
      - hold-for-production:
          type: approval
          requires:
            - notify-awaiting-approval
          filters:
            branches:
              only: main

      - deploy:
          name: deploy-prod
          environment: prod
          app-name: robot-api-prod
          requires:
            - hold-for-production
          context: slack-notifications
          filters:
            branches:
              only: main

# Summary:
# - Orbs: node@7.2.1, slack@4.13.3, custom robot-fleet (inline)
# - Flow: build -> test/build-image -> deploy (dev/staging/prod)
# - Branches: feature/* -> dev, main -> staging + prod (with approval)
# - Slack notifications demonstrate BOTH methods:
#     [WEBHOOK] - manual curl, uses SLACK_WEBHOOK env var
#     [ORB] - slack/notify, uses SLACK_ACCESS_TOKEN (OAuth)
# - Context 'slack-notifications' provides both secrets
# - Machine executor used for Docker image builds (Docker-in-Docker)
