# ============================================================================
# MODULE 3: Production Orbs Integration with Slack Notifications
# ============================================================================
# Real-world pipeline for Globomantics Robot Fleet API:
#   - circleci/node: Battle-tested Node.js workflows
#   - circleci/slack: Rich notifications to #circleci-builds
#   - Approval gates before production
#   - Simulated Azure deployments (no actual cloud resources)
#
# TEACHING POINTS:
#   - Orb version pinning strategy (@6.1.2 exact for stability)
#   - Context-based secrets management (slack-notifications)
#   - Notification strategy (fail fast on tests, confirm deployments)
#   - Approval workflow pattern for production safety
# ============================================================================

version: 2.1

# ============================================================================
# ORBS: Certified packages from CircleCI ecosystem
# ============================================================================
orbs:
  node: circleci/node@6.1.0         # Node.js convenience commands with caching
  slack: circleci/slack@4.14.0      # Slack notifications with rich templates

# ============================================================================
# EXECUTORS: Reusable execution environments
# ============================================================================
executors:
  node-executor:
    docker:
      - image: cimg/node:20.18.1    # Official CircleCI Node 20 LTS image
    working_directory: ~/robot-fleet-api
    resource_class: medium          # 2 vCPU, 4GB RAM

# ============================================================================
# COMMANDS: Reusable step sequences
# ============================================================================
commands:
  # Simulate Azure deployment without actual cloud resources
  simulate-azure-deployment:
    parameters:
      environment:
        type: enum
        enum: [dev, staging, prod]
        description: "Target environment"
      app-name:
        type: string
        description: "Azure Container App name"
    steps:
      - run:
          name: Simulate Azure Container Build
          command: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  SIMULATED: Building container image"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Image: robot-fleet-api:${CIRCLE_SHA1:0:7}"
            echo "Environment: << parameters.environment >>"
            echo "Build completed successfully âœ“"
            sleep 2  # Simulate build time
            
      - run:
          name: Simulate Azure Container App Deployment
          command: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  SIMULATED: Deploying to Azure Container Apps"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "App Name: << parameters.app-name >>"
            echo "Resource Group: rg-globomantics-<< parameters.environment >>"
            echo "Image: robot-fleet-api:${CIRCLE_SHA1:0:7}"
            echo ""
            echo "Deployment steps:"
            echo "  1. Authenticating to Azure... âœ“"
            echo "  2. Pushing image to ACR... âœ“"
            echo "  3. Updating container app... âœ“"
            echo "  4. Verifying health check... âœ“"
            echo ""
            echo "Deployment URL: https://<< parameters.app-name >>.azurecontainerapps.io"
            echo "Status: RUNNING"
            echo ""
            echo "Deployment completed successfully âœ“"
            
      - run:
          name: Simulate Health Check
          command: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  SIMULATED: Health Check"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Endpoint: https://<< parameters.app-name >>.azurecontainerapps.io/api/health"
            echo ""
            for i in {1..3}; do
              echo "Attempt $i/3... âœ“ HTTP 200 OK"
              sleep 1
            done
            echo ""
            echo "Health check passed âœ“"

# ============================================================================
# JOBS: Complete units of work
# ============================================================================
jobs:
  # Build the application and cache dependencies
  build:
    executor: node-executor
    steps:
      - checkout
      
      # Orb command handles: restore_cache, npm ci, save_cache automatically
      - node/install-packages:
          pkg-manager: npm
          cache-version: v1
      
      - run:
          name: Build Application
          command: |
            echo "Building Robot Fleet API..."
            npm run build
            echo "Build completed successfully âœ“"
      
      # Persist artifacts for downstream jobs
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - dist
            - package*.json

  # Run test suite with Slack notification on failure
  test:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      
      - run:
          name: Run Unit Tests
          command: |
            echo "Running Robot Fleet API test suite..."
            npm test
            echo "Tests completed successfully âœ“"
      
      - store_test_results:
          path: test-results
      
      - store_artifacts:
          path: coverage
          destination: coverage-report
      
      # CRITICAL: Notify on test failure (fail fast pattern)
      # Only notifies if previous steps failed
      - slack/notify:
          event: fail
          template: basic_fail_1
          channel: C08A48PLBH3  # #circleci-builds channel ID

  # Simulate deployment to Azure environment
  deploy:
    executor: node-executor
    parameters:
      environment:
        type: enum
        enum: [dev, staging, prod]
        description: "Deployment environment"
      app-name:
        type: string
        description: "Azure Container App name"
    steps:
      - checkout
      - attach_workspace:
          at: .
      
      # Simulate Azure deployment (no actual cloud resources)
      - simulate-azure-deployment:
          environment: << parameters.environment >>
          app-name: << parameters.app-name >>
      
      # Notify on successful deployment
      - slack/notify:
          event: pass
          custom: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ Deployment Successful",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n<< parameters.environment >>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*App:*\n<< parameters.app-name >>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${CIRCLE_BRANCH}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${CIRCLE_SHA1:0:7}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL:*\nhttps://<< parameters.app-name >>.azurecontainerapps.io"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Pipeline #${CIRCLE_BUILD_NUM} | <${CIRCLE_BUILD_URL}|View Build>"
                    }
                  ]
                }
              ]
            }
          channel: C08A48PLBH3  # #circleci-builds channel ID

# ============================================================================
# WORKFLOWS: Orchestrate job execution with approval gates
# ============================================================================
workflows:
  version: 2
  
  # Primary workflow: Build â†’ Test â†’ Dev â†’ Staging â†’ Approve â†’ Prod
  build-test-deploy:
    jobs:
      # Build on all branches
      - build:
          filters:
            branches:
              only:
                - main
                - develop
                - /feature\/.*/
      
      # Test after successful build
      # Context provides SLACK_WEBHOOK env var
      - test:
          requires:
            - build
          context: slack-notifications
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DEV ENVIRONMENT: Auto-deploy after tests pass
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - deploy:
          name: deploy-dev
          environment: dev
          app-name: robot-api-dev
          requires:
            - test
          context: slack-notifications
          filters:
            branches:
              only:
                - develop
                - /feature\/.*/
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # STAGING ENVIRONMENT: Auto-deploy from main branch only
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - deploy:
          name: deploy-staging
          environment: staging
          app-name: robot-api-staging
          requires:
            - test
          context: slack-notifications
          filters:
            branches:
              only: main
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # APPROVAL GATE: Manual intervention required for production
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      # Slack notification: "Staging deployed, ready for prod approval"
      - slack/on-hold:
          context: slack-notifications
          requires:
            - deploy-staging
          filters:
            branches:
              only: main
      
      # Pause workflow for human approval
      - hold-for-production:
          type: approval
          requires:
            - deploy-staging
            - slack/on-hold
          filters:
            branches:
              only: main
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PRODUCTION ENVIRONMENT: Only after manual approval
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - deploy:
          name: deploy-prod
          environment: prod
          app-name: robot-api-prod
          requires:
            - hold-for-production
          context: slack-notifications
          filters:
            branches:
              only: main

# ============================================================================
# DEMO SCENARIOS
# ============================================================================
# 
# Scenario 1: Feature Branch
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Branch: feature/new-robot-endpoint
# Flow: build â†’ test â†’ deploy-dev
# Notifications: Test failure (if tests fail)
#                Deployment success (dev environment)
#
# Scenario 2: Main Branch (Full Pipeline)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Branch: main
# Flow: build â†’ test â†’ deploy-staging â†’ [approval gate] â†’ deploy-prod
# Notifications: Test failure (if tests fail)
#                Staging deployment success
#                Production approval needed
#                Production deployment success
#
# Scenario 3: Test Failure
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Branch: any
# Flow: build â†’ test [FAILS]
# Notifications: Slack alert to #circleci-builds with failure details
# Result: Pipeline stops, no deployments occur
#
# ============================================================================
# TEACHING POINTS DEMONSTRATED
# ============================================================================
#
# 1. ORB VERSION PINNING:
#    node@6.1.0    - Gets all 6.1.x patches (recommended for stability)
#    slack@4.14.0  - Exact version (maximum stability)
#    
#    Why not @6 or @4? Because major version pins get breaking changes.
#    Why not @volatile? Because it's literally called "volatile" - never use it.
#
# 2. CONTEXT-BASED SECRETS:
#    context: slack-notifications
#    - Stores SLACK_WEBHOOK securely
#    - Scoped to organization
#    - No secrets in config file
#    - Least privilege access
#
# 3. NOTIFICATION STRATEGY:
#    Tests: Notify on FAILURE only (fail fast)
#    Deployments: Notify on SUCCESS (confirmation)
#    Why? Tests fail frequently during dev, but deployments are milestones.
#
# 4. APPROVAL GATES:
#    type: approval pauses the workflow
#    Human clicks "Approve" in CircleCI UI
#    Audit trail: who approved, when, from which IP
#    Compliance requirement for production changes
#
# 5. WORKSPACE PERSISTENCE:
#    persist_to_workspace: Saves build artifacts
#    attach_workspace: Loads artifacts in downstream jobs
#    Why? Avoids rebuilding in every job (faster, more reliable)
#
# 6. BRANCH FILTERING:
#    Feature branches â†’ dev only
#    Main branch â†’ staging + prod (after approval)
#    Prevents accidental production deployments from feature branches
#
# ============================================================================
